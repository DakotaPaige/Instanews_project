const url = 'https://api.nytimes.com/svc/topstories/v2/';
const apiKey = '9ef02a0589784f0db09a4dd1cbaea8ab';
const numberStories = 12;

//Retrieve NYT top stories
$(document).ready( function() {

  $('#sectionDropdown').on('change', function(event){
    
    $( '.site-header' ).css( 'height', 'auto' ); //Update header height
    $( '.site-header' ).addClass( 'site-header__results-loaded' );
    $( '#siteHeaderLogo' ).removeClass( 'site-header__logo' ).addClass( 'site-header__logo__results-loaded' );
    $( '.search-form' ).addClass( 'search-form__results-loaded' );
    $( 'article.story' ).remove(); //Remove existing search results
    $( 'footer' ).css( 'position', 'fixed' );
    $( '.main-content__loading-animation' ).show();

    //Build API query string based on user selection
    let searchSelection = $(this).val().toLowerCase();
    searchURL = url + searchSelection + '.json' 
    searchURL += '?' + $.param({
      'api-key': apiKey
    });
    
    //AJAX call to New York Times API
    $.ajax({
      url: searchURL,
      method: 'GET',
    })
    .done( function( data ) {
      $( '.main-content__loading-animation' ).hide();
      

      //Process search results
      var results = data.results;
      var resultCounter = 0;

      $.each(results, function( key, value ){
        
        if( resultCounter === numberStories ) {
          return false;
        }

        if( value.multimedia[4] == undefined ){
          return true;
        }
        
        let articleImage = value.multimedia[4].url;
        let articleURL = value.url;
        let articleTitle = value.abstract;

        let searchResult = '';
        searchResult = '<article class="story" style="background: url(\''+ articleImage + '\')';
        searchResult += ' center top / auto 100% no-repeat; ">';
        searchResult += '<a href="' + articleURL + '">';
        searchResult += '<p>' + articleTitle + '</p>';
        searchResult += '</article>';
        $('#searchResults').append(searchResult);

        resultCounter++;
      });
      $('footer').css( 'position', 'static' );
    })
    .fail(function(err) {
      console.log('fail');
    })
   });
});