const url = 'https://api.nytimes.com/svc/topstories/v2/';
const apiKey = '9ef02a0589784f0db09a4dd1cbaea8ab';
const numberStories = 12;  //Number of stories to display

//Retrieve NYT top stories
$(document).ready( function() {

  $('#sectionDropdown').on('change', function(event){ //When user chooses a news topic
    
    //Update site header format
    $( '.site-header' ).css( 'height', 'auto' ); 
    $( '.site-header' ).addClass( 'site-header__results-loaded' );
    $( '#siteHeaderLogo' ).removeClass( 'site-header__logo' ).addClass( 'site-header__logo__results-loaded' );
    $( '.search-form' ).addClass( 'search-form__results-loaded' );

    $( 'article.story' ).remove(); //Remove existing search results
    $( '.story-grid__loading-animation' ).show(); //Show loading GIF

    //Build API query string based on news topic selected by user
    let searchSelection = $(this).val().toLowerCase();
    searchURL = url + searchSelection + '.json' 
    searchURL += '?' + $.param({
      'api-key': apiKey
    });
    
    //AJAX call to New York Times API
    $.ajax({
      url: searchURL,
      method: 'GET',
    })
    .done( function( data ) {

      $( '.story-grid__loading-animation' ).hide();  //Hide loading GIF
    
      
      //Process news stories (AJAX data)
      var results = data.results;
      var resultCounter = 0;
      
      //Create a html element for  news story
      $.each(results, function( key, value ){
        
        if( resultCounter === numberStories ) {  //Only display specified number of stories
          return false;
        }

        if( value.multimedia[4] == undefined ){  //Do not display story if image is missing
          return true;
        }
        
        //Read story components from AJAX results
        let articleImage = value.multimedia[4].url;
        let articleURL = value.url;
        let articleTitle = value.abstract;

        //Build html element for story
        let searchResult = '';
        searchResult = '<article class="story" style="background: url(\''+ articleImage + '\')';
        searchResult += ' center top / auto 100% no-repeat; ">';
        searchResult += '<a href="' + articleURL + '">';
        searchResult += '<p>' + articleTitle + '</p>';
        searchResult += '</article>';
        $('#searchResults').append(searchResult); //Add story element to document

        resultCounter++;

      });

      $('footer').css( 'position', 'static' ); //Position footer after content
    })
    .fail(function(err) {
    })
   });
});